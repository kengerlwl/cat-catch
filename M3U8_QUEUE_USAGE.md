# M3U8 队列下载管理系统使用说明

## 功能特性

### 🚀 核心功能
- **队列管理**：最多同时下载2个m3u8任务，其他任务自动排队等待
- **断点续传**：下载失败后重试时，自动跳过已下载的片段，避免重复下载
- **边下边存**：支持流式下载，边下载边保存到本地
- **任务管理**：完整的任务生命周期管理（排队→下载→暂停→恢复→完成→失败→重试）
- **防重复下载**：自动检测重复任务，防止同一文件被重复添加到队列

### 📋 界面功能
- **实时状态显示**：队列数量、下载中任务、已完成、失败任务统计
- **进度可视化**：每个任务的下载进度条和详细信息
- **操作控制**：暂停、恢复、重试、删除任务
- **批量操作**：暂停全部、恢复全部、清理已完成任务

## 使用方法

### 1. 基本设置

在M3U8解析页面，你会看到"队列管理设置"配置区域：

```
队列管理设置
├── ☑ 启用队列管理          # 开启队列功能
├── 最大并发数: [2]          # 同时下载的任务数量(1-10)
├── ☑ 边下边存              # 启用流式下载(默认开启)
└── [添加到队列] [显示队列管理器]  # 操作按钮
```

### 2. 添加下载任务

**方法一：直接添加到队列**
1. 解析M3U8文件后，点击"添加到队列"按钮
2. 任务会自动添加到队列管理器中

**方法二：启用队列后下载**
1. 确保"启用队列管理"已勾选
2. 点击"合并下载(队列)"按钮，任务会自动加入队列

### 3. 队列管理界面

队列管理器会显示在页面顶部，包含：

#### 控制面板
```
M3U8 下载队列管理
[暂停全部] [恢复全部] [清理已完成]    队列: 2 | 下载中: 1 | 已完成: 5 | 失败: 0
```

#### 任务列表
每个任务显示：
- **任务信息**：标题、状态、片段进度、创建时间
- **进度条**：可视化下载进度
- **操作按钮**：根据任务状态显示不同操作

### 4. 任务状态说明

| 状态 | 说明 | 可用操作 |
|------|------|----------|
| **排队等待** | 等待下载槽位 | 暂停、删除 |
| **下载中** | 正在下载 | 暂停、停止 |
| **已暂停** | 用户暂停 | 恢复、删除 |
| **已完成** | 下载完成 | 删除 |
| **失败** | 下载失败 | 重试、删除 |

### 5. 断点续传功能

当任务下载失败或被暂停后：

1. **自动保存进度**：已下载的片段信息会保存到浏览器本地存储
2. **智能恢复**：重试时自动跳过已下载的片段
3. **进度显示**：显示"已完成片段/总片段"数量

```
示例：片段: 150/200  (表示200个片段中已下载150个)
```

### 6. 防重复下载机制

系统会自动检测以下情况并阻止重复下载：
- **相同URL**：同一个M3U8地址
- **相同片段数量**：确保是同一个视频
- **排除失败任务**：失败的任务可以重新添加

当检测到重复任务时，会弹出提示："任务已存在，请勿重复添加！"

### 7. 边下边存功能

启用"边下边存"后：
- 下载的数据会实时写入本地文件
- 不需要等待全部下载完成
- 减少内存占用
- 支持超大文件下载

## 高级功能

### 8. 页面刷新处理

当网站要求刷新页面重新点击下载时，系统会：
1. **保存队列状态**：所有任务信息保存到本地存储
2. **自动恢复**：页面重新加载后自动恢复队列
3. **继续处理**：如果有空闲槽位，自动开始下载

### 9. 任务持久化

所有任务信息都会保存到浏览器本地存储：
- **任务配置**：下载设置、文件名、范围等
- **下载进度**：已完成和失败的片段信息
- **队列状态**：排队、暂停、完成等状态

即使关闭浏览器重新打开，所有任务信息都会自动恢复。

### 10. 并发控制

- **最大并发数**：可设置1-10个同时下载任务
- **智能队列**：超过限制的任务自动排队等待
- **资源优化**：避免过多并发导致网络拥堵

## 操作指南

### 添加任务
1. 在M3U8页面解析视频文件
2. 配置下载参数（线程数、文件名、下载范围等）
3. 启用队列管理
4. 点击"合并下载(队列)"或"添加到队列"

### 管理任务
1. 点击"显示队列管理器"查看所有任务
2. 使用任务右侧的操作按钮进行控制
3. 使用顶部的批量操作按钮管理多个任务

### 处理失败
1. 失败的任务会显示红色边框
2. 点击"恢复"按钮重试下载
3. 系统会自动跳过已下载的片段

### 清理任务
1. 使用"清理已完成"按钮批量删除完成的任务
2. 手动删除不需要的任务
3. 系统会自动清理相关的断点续传数据

## 注意事项

1. **浏览器支持**：需要现代浏览器支持localStorage
2. **存储空间**：大量任务可能占用较多本地存储空间
3. **网络稳定**：建议在网络稳定的环境下使用
4. **并发限制**：不建议设置过高的并发数，可能影响下载稳定性

## 故障排除

### 任务无法添加
- 检查是否已启用队列管理
- 确认M3U8文件已正确解析
- 查看是否有重复任务

### 下载失败
- 检查网络连接
- 尝试降低并发数
- 使用恢复功能重试

### 进度丢失
- 检查浏览器是否禁用了localStorage
- 确认没有清除浏览器数据
- 重新添加任务到队列

## 技术实现

- **前端框架**：原生JavaScript + jQuery
- **存储方案**：localStorage + sessionStorage
- **下载引擎**：基于现有的Downloader类
- **UI组件**：响应式设计，支持移动端
- **事件系统**：完整的事件监听和处理机制
