<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 下载管理器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎬 M3U8 下载管理器</h1>
            <p class="subtitle">管理您的视频下载任务</p>
            <div class="header-controls">
                <button id="settingsBtn" class="btn btn-info">⚙️ 设置</button>
                <button id="queueStatusBtn" class="btn btn-secondary">📊 队列状态</button>
                <a href="/prompts" class="btn btn-primary" title="管理大模型提示词模板">💬 Prompt管理</a>
                <a href="/llm-config" class="btn btn-warning" title="配置大模型API参数">🤖 LLM配置</a>
            </div>
            <div class="nav-description">
                <p>💡 新功能：现在支持大模型集成！可以管理提示词模板和配置API参数</p>
            </div>
        </header>

        <!-- 设置面板 -->
        <section id="settingsPanel" class="settings-panel" style="display: none;">
            <h2>⚙️ 系统设置</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>📥 下载设置</h3>
                    <div class="form-group">
                        <label for="threadCount">默认线程数:</label>
                        <input type="number" id="threadCount" class="form-control" min="1" max="16" value="6">
                        <small>每个任务的下载线程数 (1-16)</small>
                    </div>
                    <div class="form-group">
                        <label for="downloadTimeout">下载超时 (秒):</label>
                        <input type="number" id="downloadTimeout" class="form-control" min="5" max="300" value="30">
                        <small>单个切片下载超时时间 (5-300秒)</small>
                    </div>
                    <div class="form-group">
                        <label for="maxRetryCount">最大重试次数:</label>
                        <input type="number" id="maxRetryCount" class="form-control" min="0" max="10" value="3">
                        <small>下载失败时的重试次数 (0-10次)</small>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>🚀 并发控制</h3>
                    <div class="form-group">
                        <label for="maxConcurrentTasks">最大并发任务数:</label>
                        <input type="number" id="maxConcurrentTasks" class="form-control" min="1" max="10" value="2">
                        <small>同时进行的下载任务数量 (1-10)</small>
                    </div>
                    <div class="queue-status-display">
                        <div class="status-item">
                            <span class="status-label">活跃任务:</span>
                            <span id="activeTasksCount" class="status-value">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">排队任务:</span>
                            <span id="queuedTasksCount" class="status-value">0</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>🎬 转换设置</h3>
                    <div class="form-group">
                        <label for="ffmpegThreads">FFmpeg线程数:</label>
                        <input type="number" id="ffmpegThreads" class="form-control" min="1" max="16" value="4">
                        <small>视频转换时使用的线程数 (1-16)</small>
                    </div>
                    <div class="form-group">
                        <label for="autoCleanupDays">自动清理天数:</label>
                        <input type="number" id="autoCleanupDays" class="form-control" min="1" max="30" value="7">
                        <small>自动清理完成任务的天数 (1-30天)</small>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>🤖 AI功能</h3>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="enableAiNaming" class="form-check-input">
                            <label for="enableAiNaming" class="form-check-label">启用AI智能命名</label>
                        </div>
                        <small>启用后，创建M3U8任务时会自动使用AI优化电影名称</small>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button id="saveSettingsBtn" class="btn btn-primary">💾 保存设置</button>
                <button id="resetSettingsBtn" class="btn btn-warning">🔄 重置默认</button>
                <button id="closeSettingsBtn" class="btn btn-secondary">❌ 关闭</button>
            </div>
        </section>

        <!-- 添加新任务 -->
        <section class="add-task-section">
            <h2>📥 添加下载任务</h2>
            <div class="form-row">
                <div class="form-group flex-grow">
                    <label for="m3u8Url">M3U8 链接:</label>
                    <input type="url" id="m3u8Url" placeholder="请输入M3U8链接" class="form-control">
                </div>
                <div class="form-group">
                    <label for="taskThreadCount">线程数:</label>
                    <input type="number" id="taskThreadCount" class="form-control" min="1" max="16" value="6" style="width: 80px;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="taskTitle">任务标题:</label>
                    <input type="text" id="taskTitle" placeholder="可选，留空将自动生成" class="form-control">
                </div>
                <div class="form-group">
                    <label for="customDir">自定义目录:</label>
                    <input type="text" id="customDir" placeholder="可选，自定义下载目录" class="form-control">
                </div>
            </div>
            <button id="addTaskBtn" class="btn btn-primary">🚀 添加任务</button>
        </section>

        <!-- 任务列表 -->
        <section class="tasks-section">
            <h2>📋 下载任务列表</h2>
            <div class="tasks-header">
                <div class="tasks-header-left">
                    <button id="refreshBtn" class="btn btn-secondary">🔄 刷新</button>
                    <div class="refresh-status">
                        <span id="refreshIndicator" class="refresh-indicator">🔄</span>
                        <span id="refreshMode" class="refresh-mode">智能刷新</span>
                    </div>
                </div>
                <div class="tasks-header-center">
                    <div class="batch-controls">
                        <label class="batch-select-all">
                            <input type="checkbox" id="selectAllTasks"> 全选
                        </label>
                        <div class="batch-actions">
                            <button id="batchPauseBtn" class="btn btn-warning" disabled>⏸️ 批量暂停</button>
                            <button id="batchResumeBtn" class="btn btn-success" disabled>▶️ 批量恢复</button>
                            <button id="batchConvertBtn" class="btn btn-info" disabled>🔄 批量转换MP4</button>
                            <button id="batchDeleteBtn" class="btn btn-danger" disabled>🗑️ 批量删除</button>
                        </div>
                        <span id="selectedCount" class="selected-count">已选择 0 个任务</span>
                    </div>
                </div>
                <div class="tasks-header-right">
                    <span id="taskCount" class="task-count">共 0 个任务</span>
                </div>
            </div>
            <div id="tasksList" class="tasks-list">
                <!-- 任务项将通过JavaScript动态添加 -->
            </div>
        </section>
    </div>

    <!-- 播放模态框 -->
    <div id="playModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>视频播放</h3>
            <video id="playVideo" controls style="width: 100%; max-width: 800px;">
                您的浏览器不支持视频播放
            </video>
        </div>
    </div>

    <!-- 编辑任务模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>编辑任务</h3>
            <div class="form-group">
                <label for="editUrl">M3U8 链接:</label>
                <input type="url" id="editUrl" class="form-control">
            </div>
            <div class="form-group">
                <label for="editTitle">任务标题:</label>
                <input type="text" id="editTitle" class="form-control">
            </div>
            <div class="modal-actions">
                <button id="saveEditBtn" class="btn btn-primary">💾 保存</button>
                <button id="cancelEditBtn" class="btn btn-secondary">❌ 取消</button>
            </div>
        </div>
    </div>

    <!-- 批量转换进度模态框 -->
    <div id="batchConvertModal" class="modal batch-convert-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>🔄 批量转换进度</h3>
            <div class="convert-summary">
                <p>正在串行转换选中的任务，请耐心等待...</p>
                <div class="progress-summary">
                    <span>总进度: </span>
                    <span id="convertOverallProgress">0/0</span>
                    <span> | 当前: </span>
                    <span id="convertCurrentTask">等待开始...</span>
                </div>
            </div>
            <div id="convertProgressList" class="convert-progress-list">
                <!-- 转换进度项将通过JavaScript动态添加 -->
            </div>
            <div class="modal-actions">
                <button id="stopBatchConvertBtn" class="btn btn-warning">⏹️ 停止转换</button>
                <button id="closeBatchConvertBtn" class="btn btn-secondary" disabled>❌ 关闭</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
